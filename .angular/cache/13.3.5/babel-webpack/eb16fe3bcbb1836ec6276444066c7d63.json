{"ast":null,"code":"import _asyncToGenerator from \"/home/ramon/Desktop/Institut Lacet\\xE0nia/S\\xEDntesi/Projecte/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { encode as base64url } from '../../runtime/base64url.js';\nimport sign from '../../runtime/sign.js';\nimport isDisjoint from '../../lib/is_disjoint.js';\nimport { JWSInvalid } from '../../util/errors.js';\nimport { encoder, decoder, concat } from '../../lib/buffer_utils.js';\nimport checkKeyType from '../../lib/check_key_type.js';\nimport validateCrit from '../../lib/validate_crit.js';\nexport class FlattenedSign {\n  constructor(payload) {\n    if (!(payload instanceof Uint8Array)) {\n      throw new TypeError('payload must be an instance of Uint8Array');\n    }\n\n    this._payload = payload;\n  }\n\n  setProtectedHeader(protectedHeader) {\n    if (this._protectedHeader) {\n      throw new TypeError('setProtectedHeader can only be called once');\n    }\n\n    this._protectedHeader = protectedHeader;\n    return this;\n  }\n\n  setUnprotectedHeader(unprotectedHeader) {\n    if (this._unprotectedHeader) {\n      throw new TypeError('setUnprotectedHeader can only be called once');\n    }\n\n    this._unprotectedHeader = unprotectedHeader;\n    return this;\n  }\n\n  sign(key, options) {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      if (!_this._protectedHeader && !_this._unprotectedHeader) {\n        throw new JWSInvalid('either setProtectedHeader or setUnprotectedHeader must be called before #sign()');\n      }\n\n      if (!isDisjoint(_this._protectedHeader, _this._unprotectedHeader)) {\n        throw new JWSInvalid('JWS Protected and JWS Unprotected Header Parameter names must be disjoint');\n      }\n\n      const joseHeader = { ..._this._protectedHeader,\n        ..._this._unprotectedHeader\n      };\n      const extensions = validateCrit(JWSInvalid, new Map([['b64', true]]), options === null || options === void 0 ? void 0 : options.crit, _this._protectedHeader, joseHeader);\n      let b64 = true;\n\n      if (extensions.has('b64')) {\n        b64 = _this._protectedHeader.b64;\n\n        if (typeof b64 !== 'boolean') {\n          throw new JWSInvalid('The \"b64\" (base64url-encode payload) Header Parameter must be a boolean');\n        }\n      }\n\n      const {\n        alg\n      } = joseHeader;\n\n      if (typeof alg !== 'string' || !alg) {\n        throw new JWSInvalid('JWS \"alg\" (Algorithm) Header Parameter missing or invalid');\n      }\n\n      checkKeyType(alg, key, 'sign');\n      let payload = _this._payload;\n\n      if (b64) {\n        payload = encoder.encode(base64url(payload));\n      }\n\n      let protectedHeader;\n\n      if (_this._protectedHeader) {\n        protectedHeader = encoder.encode(base64url(JSON.stringify(_this._protectedHeader)));\n      } else {\n        protectedHeader = encoder.encode('');\n      }\n\n      const data = concat(protectedHeader, encoder.encode('.'), payload);\n      const signature = yield sign(alg, key, data);\n      const jws = {\n        signature: base64url(signature),\n        payload: ''\n      };\n\n      if (b64) {\n        jws.payload = decoder.decode(payload);\n      }\n\n      if (_this._unprotectedHeader) {\n        jws.header = _this._unprotectedHeader;\n      }\n\n      if (_this._protectedHeader) {\n        jws.protected = decoder.decode(protectedHeader);\n      }\n\n      return jws;\n    })();\n  }\n\n}","map":{"version":3,"sources":["/home/ramon/Desktop/Institut Lacetània/Síntesi/Projecte/node_modules/jose/dist/browser/jws/flattened/sign.js"],"names":["encode","base64url","sign","isDisjoint","JWSInvalid","encoder","decoder","concat","checkKeyType","validateCrit","FlattenedSign","constructor","payload","Uint8Array","TypeError","_payload","setProtectedHeader","protectedHeader","_protectedHeader","setUnprotectedHeader","unprotectedHeader","_unprotectedHeader","key","options","joseHeader","extensions","Map","crit","b64","has","alg","JSON","stringify","data","signature","jws","decode","header","protected"],"mappings":"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","sourcesContent":["import { encode as base64url } from '../../runtime/base64url.js';\nimport sign from '../../runtime/sign.js';\nimport isDisjoint from '../../lib/is_disjoint.js';\nimport { JWSInvalid } from '../../util/errors.js';\nimport { encoder, decoder, concat } from '../../lib/buffer_utils.js';\nimport checkKeyType from '../../lib/check_key_type.js';\nimport validateCrit from '../../lib/validate_crit.js';\nexport class FlattenedSign {\n    constructor(payload) {\n        if (!(payload instanceof Uint8Array)) {\n            throw new TypeError('payload must be an instance of Uint8Array');\n        }\n        this._payload = payload;\n    }\n    setProtectedHeader(protectedHeader) {\n        if (this._protectedHeader) {\n            throw new TypeError('setProtectedHeader can only be called once');\n        }\n        this._protectedHeader = protectedHeader;\n        return this;\n    }\n    setUnprotectedHeader(unprotectedHeader) {\n        if (this._unprotectedHeader) {\n            throw new TypeError('setUnprotectedHeader can only be called once');\n        }\n        this._unprotectedHeader = unprotectedHeader;\n        return this;\n    }\n    async sign(key, options) {\n        if (!this._protectedHeader && !this._unprotectedHeader) {\n            throw new JWSInvalid('either setProtectedHeader or setUnprotectedHeader must be called before #sign()');\n        }\n        if (!isDisjoint(this._protectedHeader, this._unprotectedHeader)) {\n            throw new JWSInvalid('JWS Protected and JWS Unprotected Header Parameter names must be disjoint');\n        }\n        const joseHeader = {\n            ...this._protectedHeader,\n            ...this._unprotectedHeader,\n        };\n        const extensions = validateCrit(JWSInvalid, new Map([['b64', true]]), options === null || options === void 0 ? void 0 : options.crit, this._protectedHeader, joseHeader);\n        let b64 = true;\n        if (extensions.has('b64')) {\n            b64 = this._protectedHeader.b64;\n            if (typeof b64 !== 'boolean') {\n                throw new JWSInvalid('The \"b64\" (base64url-encode payload) Header Parameter must be a boolean');\n            }\n        }\n        const { alg } = joseHeader;\n        if (typeof alg !== 'string' || !alg) {\n            throw new JWSInvalid('JWS \"alg\" (Algorithm) Header Parameter missing or invalid');\n        }\n        checkKeyType(alg, key, 'sign');\n        let payload = this._payload;\n        if (b64) {\n            payload = encoder.encode(base64url(payload));\n        }\n        let protectedHeader;\n        if (this._protectedHeader) {\n            protectedHeader = encoder.encode(base64url(JSON.stringify(this._protectedHeader)));\n        }\n        else {\n            protectedHeader = encoder.encode('');\n        }\n        const data = concat(protectedHeader, encoder.encode('.'), payload);\n        const signature = await sign(alg, key, data);\n        const jws = {\n            signature: base64url(signature),\n            payload: '',\n        };\n        if (b64) {\n            jws.payload = decoder.decode(payload);\n        }\n        if (this._unprotectedHeader) {\n            jws.header = this._unprotectedHeader;\n        }\n        if (this._protectedHeader) {\n            jws.protected = decoder.decode(protectedHeader);\n        }\n        return jws;\n    }\n}\n"]},"metadata":{},"sourceType":"module"}