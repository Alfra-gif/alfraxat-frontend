{"ast":null,"code":"import _asyncToGenerator from \"/home/ramon/Desktop/Institut Lacet\\xE0nia/S\\xEDntesi/Projecte/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport fetchJwks from '../runtime/fetch_jwks.js';\nimport { isCloudflareWorkers } from '../runtime/env.js';\nimport { JWKSInvalid, JWKSNoMatchingKey } from '../util/errors.js';\nimport { isJWKSLike, LocalJWKSet } from './local.js';\n\nclass RemoteJWKSet extends LocalJWKSet {\n  constructor(url, options) {\n    super({\n      keys: []\n    });\n    this._jwks = undefined;\n\n    if (!(url instanceof URL)) {\n      throw new TypeError('url must be an instance of URL');\n    }\n\n    this._url = new URL(url.href);\n    this._options = {\n      agent: options === null || options === void 0 ? void 0 : options.agent,\n      headers: options === null || options === void 0 ? void 0 : options.headers\n    };\n    this._timeoutDuration = typeof (options === null || options === void 0 ? void 0 : options.timeoutDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.timeoutDuration : 5000;\n    this._cooldownDuration = typeof (options === null || options === void 0 ? void 0 : options.cooldownDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.cooldownDuration : 30000;\n    this._cacheMaxAge = typeof (options === null || options === void 0 ? void 0 : options.cacheMaxAge) === 'number' ? options === null || options === void 0 ? void 0 : options.cacheMaxAge : 600000;\n  }\n\n  coolingDown() {\n    return typeof this._jwksTimestamp === 'number' ? Date.now() < this._jwksTimestamp + this._cooldownDuration : false;\n  }\n\n  fresh() {\n    return typeof this._jwksTimestamp === 'number' ? Date.now() < this._jwksTimestamp + this._cacheMaxAge : false;\n  }\n\n  getKey(protectedHeader, token) {\n    var _superprop_getGetKey = () => super.getKey,\n        _this = this;\n\n    return _asyncToGenerator(function* () {\n      if (!_this._jwks || !_this.fresh()) {\n        yield _this.reload();\n      }\n\n      try {\n        return yield _superprop_getGetKey().call(_this, protectedHeader, token);\n      } catch (err) {\n        if (err instanceof JWKSNoMatchingKey) {\n          if (_this.coolingDown() === false) {\n            yield _this.reload();\n            return _superprop_getGetKey().call(_this, protectedHeader, token);\n          }\n        }\n\n        throw err;\n      }\n    })();\n  }\n\n  reload() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      if (_this2._pendingFetch && isCloudflareWorkers()) {\n        return new Promise(resolve => {\n          const isDone = () => {\n            if (_this2._pendingFetch === undefined) {\n              resolve();\n            } else {\n              setTimeout(isDone, 5);\n            }\n          };\n\n          isDone();\n        });\n      }\n\n      if (!_this2._pendingFetch) {\n        _this2._pendingFetch = fetchJwks(_this2._url, _this2._timeoutDuration, _this2._options).then(json => {\n          if (!isJWKSLike(json)) {\n            throw new JWKSInvalid('JSON Web Key Set malformed');\n          }\n\n          _this2._jwks = {\n            keys: json.keys\n          };\n          _this2._jwksTimestamp = Date.now();\n          _this2._pendingFetch = undefined;\n        }).catch(err => {\n          _this2._pendingFetch = undefined;\n          throw err;\n        });\n      }\n\n      yield _this2._pendingFetch;\n    })();\n  }\n\n}\n\nexport function createRemoteJWKSet(url, options) {\n  return RemoteJWKSet.prototype.getKey.bind(new RemoteJWKSet(url, options));\n}","map":{"version":3,"sources":["/home/ramon/Desktop/Institut Lacetània/Síntesi/Projecte/node_modules/jose/dist/browser/jwks/remote.js"],"names":["fetchJwks","isCloudflareWorkers","JWKSInvalid","JWKSNoMatchingKey","isJWKSLike","LocalJWKSet","RemoteJWKSet","constructor","url","options","keys","_jwks","undefined","URL","TypeError","_url","href","_options","agent","headers","_timeoutDuration","timeoutDuration","_cooldownDuration","cooldownDuration","_cacheMaxAge","cacheMaxAge","coolingDown","_jwksTimestamp","Date","now","fresh","getKey","protectedHeader","token","reload","err","_pendingFetch","Promise","resolve","isDone","setTimeout","then","json","catch","createRemoteJWKSet","prototype","bind"],"mappings":";AAAA,OAAOA,SAAP,MAAsB,0BAAtB;AACA,SAASC,mBAAT,QAAoC,mBAApC;AACA,SAASC,WAAT,EAAsBC,iBAAtB,QAA+C,mBAA/C;AACA,SAASC,UAAT,EAAqBC,WAArB,QAAwC,YAAxC;;AACA,MAAMC,YAAN,SAA2BD,WAA3B,CAAuC;AACnCE,EAAAA,WAAW,CAACC,GAAD,EAAMC,OAAN,EAAe;AACtB,UAAM;AAAEC,MAAAA,IAAI,EAAE;AAAR,KAAN;AACA,SAAKC,KAAL,GAAaC,SAAb;;AACA,QAAI,EAAEJ,GAAG,YAAYK,GAAjB,CAAJ,EAA2B;AACvB,YAAM,IAAIC,SAAJ,CAAc,gCAAd,CAAN;AACH;;AACD,SAAKC,IAAL,GAAY,IAAIF,GAAJ,CAAQL,GAAG,CAACQ,IAAZ,CAAZ;AACA,SAAKC,QAAL,GAAgB;AAAEC,MAAAA,KAAK,EAAET,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACS,KAAnE;AAA0EC,MAAAA,OAAO,EAAEV,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACU;AAA7I,KAAhB;AACA,SAAKC,gBAAL,GACI,QAAQX,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACY,eAAlE,MAAuF,QAAvF,GAAkGZ,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACY,eAA5J,GAA8K,IADlL;AAEA,SAAKC,iBAAL,GACI,QAAQb,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACc,gBAAlE,MAAwF,QAAxF,GAAmGd,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACc,gBAA7J,GAAgL,KADpL;AAEA,SAAKC,YAAL,GAAoB,QAAQf,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACgB,WAAlE,MAAmF,QAAnF,GAA8FhB,OAAO,KAAK,IAAZ,IAAoBA,OAAO,KAAK,KAAK,CAArC,GAAyC,KAAK,CAA9C,GAAkDA,OAAO,CAACgB,WAAxJ,GAAsK,MAA1L;AACH;;AACDC,EAAAA,WAAW,GAAG;AACV,WAAO,OAAO,KAAKC,cAAZ,KAA+B,QAA/B,GACDC,IAAI,CAACC,GAAL,KAAa,KAAKF,cAAL,GAAsB,KAAKL,iBADvC,GAED,KAFN;AAGH;;AACDQ,EAAAA,KAAK,GAAG;AACJ,WAAO,OAAO,KAAKH,cAAZ,KAA+B,QAA/B,GACDC,IAAI,CAACC,GAAL,KAAa,KAAKF,cAAL,GAAsB,KAAKH,YADvC,GAED,KAFN;AAGH;;AACKO,EAAAA,MAAM,CAACC,eAAD,EAAkBC,KAAlB,EAAyB;AAAA;AAAA;;AAAA;AACjC,UAAI,CAAC,KAAI,CAACtB,KAAN,IAAe,CAAC,KAAI,CAACmB,KAAL,EAApB,EAAkC;AAC9B,cAAM,KAAI,CAACI,MAAL,EAAN;AACH;;AACD,UAAI;AACA,qBAAa,mCAAaF,eAAb,EAA8BC,KAA9B,CAAb;AACH,OAFD,CAGA,OAAOE,GAAP,EAAY;AACR,YAAIA,GAAG,YAAYhC,iBAAnB,EAAsC;AAClC,cAAI,KAAI,CAACuB,WAAL,OAAuB,KAA3B,EAAkC;AAC9B,kBAAM,KAAI,CAACQ,MAAL,EAAN;AACA,mBAAO,mCAAaF,eAAb,EAA8BC,KAA9B,CAAP;AACH;AACJ;;AACD,cAAME,GAAN;AACH;AAfgC;AAgBpC;;AACKD,EAAAA,MAAM,GAAG;AAAA;;AAAA;AACX,UAAI,MAAI,CAACE,aAAL,IAAsBnC,mBAAmB,EAA7C,EAAiD;AAC7C,eAAO,IAAIoC,OAAJ,CAAaC,OAAD,IAAa;AAC5B,gBAAMC,MAAM,GAAG,MAAM;AACjB,gBAAI,MAAI,CAACH,aAAL,KAAuBxB,SAA3B,EAAsC;AAClC0B,cAAAA,OAAO;AACV,aAFD,MAGK;AACDE,cAAAA,UAAU,CAACD,MAAD,EAAS,CAAT,CAAV;AACH;AACJ,WAPD;;AAQAA,UAAAA,MAAM;AACT,SAVM,CAAP;AAWH;;AACD,UAAI,CAAC,MAAI,CAACH,aAAV,EAAyB;AACrB,QAAA,MAAI,CAACA,aAAL,GAAqBpC,SAAS,CAAC,MAAI,CAACe,IAAN,EAAY,MAAI,CAACK,gBAAjB,EAAmC,MAAI,CAACH,QAAxC,CAAT,CAChBwB,IADgB,CACVC,IAAD,IAAU;AAChB,cAAI,CAACtC,UAAU,CAACsC,IAAD,CAAf,EAAuB;AACnB,kBAAM,IAAIxC,WAAJ,CAAgB,4BAAhB,CAAN;AACH;;AACD,UAAA,MAAI,CAACS,KAAL,GAAa;AAAED,YAAAA,IAAI,EAAEgC,IAAI,CAAChC;AAAb,WAAb;AACA,UAAA,MAAI,CAACiB,cAAL,GAAsBC,IAAI,CAACC,GAAL,EAAtB;AACA,UAAA,MAAI,CAACO,aAAL,GAAqBxB,SAArB;AACH,SARoB,EAShB+B,KATgB,CASTR,GAAD,IAAS;AAChB,UAAA,MAAI,CAACC,aAAL,GAAqBxB,SAArB;AACA,gBAAMuB,GAAN;AACH,SAZoB,CAArB;AAaH;;AACD,YAAM,MAAI,CAACC,aAAX;AA7BW;AA8Bd;;AAxEkC;;AA0EvC,OAAO,SAASQ,kBAAT,CAA4BpC,GAA5B,EAAiCC,OAAjC,EAA0C;AAC7C,SAAOH,YAAY,CAACuC,SAAb,CAAuBd,MAAvB,CAA8Be,IAA9B,CAAmC,IAAIxC,YAAJ,CAAiBE,GAAjB,EAAsBC,OAAtB,CAAnC,CAAP;AACH","sourcesContent":["import fetchJwks from '../runtime/fetch_jwks.js';\nimport { isCloudflareWorkers } from '../runtime/env.js';\nimport { JWKSInvalid, JWKSNoMatchingKey } from '../util/errors.js';\nimport { isJWKSLike, LocalJWKSet } from './local.js';\nclass RemoteJWKSet extends LocalJWKSet {\n    constructor(url, options) {\n        super({ keys: [] });\n        this._jwks = undefined;\n        if (!(url instanceof URL)) {\n            throw new TypeError('url must be an instance of URL');\n        }\n        this._url = new URL(url.href);\n        this._options = { agent: options === null || options === void 0 ? void 0 : options.agent, headers: options === null || options === void 0 ? void 0 : options.headers };\n        this._timeoutDuration =\n            typeof (options === null || options === void 0 ? void 0 : options.timeoutDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.timeoutDuration : 5000;\n        this._cooldownDuration =\n            typeof (options === null || options === void 0 ? void 0 : options.cooldownDuration) === 'number' ? options === null || options === void 0 ? void 0 : options.cooldownDuration : 30000;\n        this._cacheMaxAge = typeof (options === null || options === void 0 ? void 0 : options.cacheMaxAge) === 'number' ? options === null || options === void 0 ? void 0 : options.cacheMaxAge : 600000;\n    }\n    coolingDown() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cooldownDuration\n            : false;\n    }\n    fresh() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cacheMaxAge\n            : false;\n    }\n    async getKey(protectedHeader, token) {\n        if (!this._jwks || !this.fresh()) {\n            await this.reload();\n        }\n        try {\n            return await super.getKey(protectedHeader, token);\n        }\n        catch (err) {\n            if (err instanceof JWKSNoMatchingKey) {\n                if (this.coolingDown() === false) {\n                    await this.reload();\n                    return super.getKey(protectedHeader, token);\n                }\n            }\n            throw err;\n        }\n    }\n    async reload() {\n        if (this._pendingFetch && isCloudflareWorkers()) {\n            return new Promise((resolve) => {\n                const isDone = () => {\n                    if (this._pendingFetch === undefined) {\n                        resolve();\n                    }\n                    else {\n                        setTimeout(isDone, 5);\n                    }\n                };\n                isDone();\n            });\n        }\n        if (!this._pendingFetch) {\n            this._pendingFetch = fetchJwks(this._url, this._timeoutDuration, this._options)\n                .then((json) => {\n                if (!isJWKSLike(json)) {\n                    throw new JWKSInvalid('JSON Web Key Set malformed');\n                }\n                this._jwks = { keys: json.keys };\n                this._jwksTimestamp = Date.now();\n                this._pendingFetch = undefined;\n            })\n                .catch((err) => {\n                this._pendingFetch = undefined;\n                throw err;\n            });\n        }\n        await this._pendingFetch;\n    }\n}\nexport function createRemoteJWKSet(url, options) {\n    return RemoteJWKSet.prototype.getKey.bind(new RemoteJWKSet(url, options));\n}\n"]},"metadata":{},"sourceType":"module"}